# 部署指南

<cite>
**Referenced Files in This Document**   
- [Dockerfile](file://Dockerfile)
- [docker-compose.yaml](file://docker-compose.yaml)
- [installer/install.sh](file://installer/install.sh)
- [installer/install.conf](file://installer/install.conf)
- [installer/sqlbot/templates/sqlbot.conf](file://installer/sqlbot/templates/sqlbot.conf)
- [installer/sqlbot/docker-compose.yml](file://installer/sqlbot/docker-compose.yml)
- [installer/sqlbot/docker-compose-pg.yml](file://installer/sqlbot/docker-compose-pg.yml)
- [start.sh](file://start.sh)
</cite>

## 目录
1. [简介](#简介)
2. [Docker部署方案](#docker部署方案)
3. [一键安装脚本](#一键安装脚本)
4. [生产环境部署最佳实践](#生产环境部署最佳实践)
5. [配置文件详解](#配置文件详解)
6. [部署后验证](#部署后验证)

## 简介
本文档旨在为SQLBot应用提供全面的部署操作手册，涵盖从基础Docker部署到生产环境最佳实践的完整流程。文档详细说明了多阶段Docker构建策略、docker-compose服务编排、一键安装脚本的工作原理以及生产环境的配置建议。通过本指南，用户可以快速、安全地完成SQLBot的部署，并根据实际需求进行定制化配置。

## Docker部署方案

### Dockerfile多阶段构建策略
SQLBot的Dockerfile采用了多阶段构建策略，将构建过程分为三个独立的阶段：`sqlbot-builder`、`ssr-builder`和运行时阶段。这种策略有效分离了构建环境和运行环境，显著减小了最终镜像的体积。

第一阶段`sqlbot-builder`负责前端和后端的构建。该阶段首先安装前端依赖并执行构建，生成静态资源文件，然后处理后端Python依赖。第二阶段`ssr-builder`专门用于构建G2图表服务，确保图表渲染功能的独立性。最终的运行时阶段则整合所有构建产物，仅包含运行应用所必需的文件和依赖，实现了最小化镜像。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L72)

### docker-compose服务编排
SQLBot的部署通过docker-compose进行服务编排，主要包含两个服务：`sqlbot`（应用服务）和`sqlbot-db`（数据库服务）。服务间通过`sqlbot-network`网络进行通信，确保了网络隔离和安全性。

应用服务`sqlbot`通过环境变量文件`conf/sqlbot.conf`注入配置，并将数据目录（包括Excel文件、图片和日志）挂载到宿主机，实现了数据的持久化存储。该服务依赖于数据库服务`sqlbot-db`，并设置了健康检查条件，确保只有在数据库服务完全健康后，应用服务才会启动，避免了因数据库未就绪导致的应用启动失败。

**Section sources**
- [installer/sqlbot/docker-compose.yml](file://installer/sqlbot/docker-compose.yml#L1-L23)
- [installer/sqlbot/docker-compose-pg.yml](file://installer/sqlbot/docker-compose-pg.yml#L1-L17)

### 环境变量配置
环境变量是连接Docker容器与外部配置的核心。SQLBot通过`env_file`指令加载`conf/sqlbot.conf`文件中的环境变量。这些变量在`docker-compose.yml`中以`${VARIABLE_NAME}`的形式引用，实现了配置的动态注入。例如，`SQLBOT_WEB_PORT`变量决定了应用服务对外暴露的端口。这种配置方式使得同一套部署文件可以在不同环境中通过修改配置文件来适应，而无需更改编排文件本身。

**Section sources**
- [installer/sqlbot/docker-compose.yml](file://installer/sqlbot/docker-compose.yml#L1-L23)
- [installer/sqlbot/templates/sqlbot.conf](file://installer/sqlbot/templates/sqlbot.conf#L1-L20)

## 一键安装脚本

### 工作原理
`install.sh`脚本是一个功能完整的自动化安装程序，它通过一系列有序的步骤完成SQLBot的部署。脚本首先检查当前环境，判断是全新安装还是升级安装。随后，它会准备运行目录，将模板文件复制到指定位置，并使用`envsubst`命令将`install.conf`中的变量值填充到模板文件中。

脚本的核心功能包括自动安装或检测Docker和Docker Compose、加载预打包的Docker镜像、配置系统设置（如防火墙和SELinux）以及最终启动服务。整个过程被设计为幂等的，意味着可以安全地重复执行，这对于升级和故障恢复至关重要。

**Section sources**
- [installer/install.sh](file://installer/install.sh#L1-L285)

### 自定义选项
`install.sh`脚本通过`install.conf`文件支持广泛的自定义选项。用户可以在安装前修改此配置文件，以适应特定的部署需求。例如，可以更改`SQLBOT_BASE`来指定不同的安装目录，或通过设置`SQLBOT_EXTERNAL_DB=true`来使用外部数据库，从而绕过内置的PostgreSQL服务。脚本会根据这些配置自动调整部署流程，如在使用外部数据库时，会从`docker-compose.yml`中移除对`sqlbot-db`服务的依赖声明。

**Section sources**
- [installer/install.sh](file://installer/install.sh#L1-L285)
- [installer/install.conf](file://installer/install.conf#L1-L34)

## 生产环境部署最佳实践

### 资源分配
在生产环境中，应根据预期的用户负载和数据处理需求合理分配计算资源。建议为SQLBot应用容器分配至少2核CPU和4GB内存，为PostgreSQL数据库容器分配至少2核CPU和8GB内存。可以通过在`docker-compose.yml`中添加`deploy.resources`部分来设置资源限制。

### 持久化存储配置
数据持久化是生产部署的关键。`docker-compose.yml`文件已通过`volumes`指令将应用的数据目录（如`/opt/sqlbot/data/sqlbot/excel`和`/opt/sqlbot/data/sqlbot/images`）挂载到宿主机。在生产环境中，应确保这些宿主机目录位于具有足够空间和高可靠性的存储设备上，并考虑使用RAID或网络存储（NAS）来提高数据安全性。

### 备份策略
必须建立定期的备份策略。建议对数据库进行每日全量备份和每小时增量备份。可以使用`pg_dump`命令或通过`docker exec`在`sqlbot-db`容器内执行备份脚本。同时，应定期备份`conf`目录下的配置文件，以便在需要时快速恢复。

### 高可用部署建议
对于高可用性要求，建议采用主从复制的PostgreSQL集群，并将SQLBot应用部署在多个节点上，前端通过负载均衡器（如Nginx或HAProxy）进行流量分发。此外，可以使用Docker Swarm或Kubernetes等编排工具来管理容器集群，实现服务的自动伸缩和故障转移。

### 监控集成方案
应集成监控系统以实时掌握应用状态。可以使用Prometheus和Grafana收集和可视化Docker容器的CPU、内存、网络和磁盘I/O指标。同时，SQLBot自身的日志（位于`/opt/sqlbot/logs`）应被Filebeat或Fluentd等工具收集，并发送到Elasticsearch进行分析，以便快速定位问题。

## 配置文件详解

### install.conf参数含义
`install.conf`是SQLBot的主要配置文件，包含了所有可自定义的参数。

- **基础配置**:
  - `SQLBOT_BASE`: 定义SQLBot的根安装目录。
  - `SQLBOT_WEB_PORT`: 应用Web服务监听的端口。
  - `SQLBOT_MCP_PORT`: MCP（模型控制程序）服务监听的端口。

- **数据库配置**:
  - `SQLBOT_EXTERNAL_DB`: 布尔值，决定是否使用外部数据库。
  - `SQLBOT_DB_HOST`: 数据库服务器地址。
  - `SQLBOT_DB_USER`/`SQLBOT_DB_PASSWORD`: 数据库连接凭据。

- **其他配置**:
  - `SQLBOT_DEFAULT_PWD`: 新用户的默认密码。
  - `SQLBOT_SECRET_KEY`: 用于加密会话和令牌的密钥，生产环境必须更换。
  - `SQLBOT_CORS_ORIGINS`: 允许跨域请求的源列表。
  - `SQLBOT_LOG_LEVEL`: 日志详细程度。
  - `SQLBOT_CACHE_TYPE`: 缓存后端类型（如"memory"或"redis"）。
  - `SQLBOT_SERVER_IMAGE_HOST`: MCP图片服务的完整URL。

**Section sources**
- [installer/install.conf](file://installer/install.conf#L1-L34)

### 调优建议
- **安全性**: `SQLBOT_SECRET_KEY`必须使用强随机字符串替换，`SQLBOT_DB_PASSWORD`也应设置为复杂密码。
- **性能**: 在高并发场景下，可将`SQLBOT_CACHE_TYPE`设置为`redis`以获得更好的缓存性能。
- **访问**: `SQLBOT_CORS_ORIGINS`应精确配置为实际需要访问的前端域名，避免设置为`*`。
- **MCP服务**: `SQLBOT_SERVER_IMAGE_HOST`中的`YOUR_SERVER_IP`和`MCP_PORT`必须替换为实际的服务器IP和端口。

## 部署后验证

### 验证步骤
1.  **服务状态检查**: 运行`docker-compose ps`命令，确认`sqlbot`和`sqlbot-db`服务的状态均为`running`。
2.  **日志检查**: 使用`docker-compose logs sqlbot`查看应用日志，确认没有错误信息，且能看到服务启动成功的提示。
3.  **端口检查**: 使用`netstat -tlnp | grep <端口号>`确认8000（Web）和8001（MCP）端口已在监听。
4.  **应用访问**: 在浏览器中访问`http://<服务器IP>:8000`，应能正常加载SQLBot的登录页面。

### 健康检查方法
SQLBot的Docker镜像内置了健康检查机制。可以通过`docker inspect <容器ID>`命令查看容器的健康状态。健康检查通过`curl -f http://localhost:8000`命令周期性地访问应用的根路径来实现。如果应用正常运行，该请求将返回HTTP 200状态码，容器状态为`healthy`；否则，状态为`unhealthy`，这有助于编排工具自动进行故障恢复。

**Section sources**
- [Dockerfile](file://Dockerfile#L69-L71)
- [installer/install.sh](file://installer/install.sh#L270-L285)
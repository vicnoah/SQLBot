# 数据库设计

<cite>
**本文档引用的文件**
- [003_add_datasource.py](file://backend/alembic/versions/003_add_datasource.py)
- [004_add_aimodel_auto.py](file://backend/alembic/versions/004_add_aimodel_auto.py)
- [007_add_chat.py](file://backend/alembic/versions/007_add_chat.py)
- [009_1_add_core_dashboard.py](file://backend/alembic/versions/009_1_add_core_dashboard.py)
- [chat_model.py](file://backend/apps/chat/models/chat_model.py)
- [datasource.py](file://backend/apps/datasource/models/datasource.py)
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py)
- [system_model.py](file://backend/apps/system/models/system_model.py)
- [019_upgrade_model.py](file://backend/alembic/versions/019_upgrade_model.py)
- [020_workspace_ddl.py](file://backend/alembic/versions/020_workspace_ddl.py)
- [021_user_ws_ddl.py](file://backend/alembic/versions/021_user_ws_ddl.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心实体模型](#核心实体模型)
3. [实体关系图](#实体关系图)
4. [数据库迁移策略](#数据库迁移策略)
5. [关键表设计考量](#关键表设计考量)
6. [结论](#结论)

## 简介
本文档详细描述了SQLBot系统的数据库设计，基于Alembic迁移脚本和SQLModel模型文件。文档重点介绍核心实体：ChatRecord（聊天记录）、CoreDatasource（数据源）、CoreDashboard（仪表板）、AiModelDetail（AI模型配置）的字段定义、数据类型和约束条件。同时，文档解释了实体间的关系，如用户与工作空间的多对多关系、聊天记录与数据源的关联，并通过ER图展示表结构和关联关系。

## 核心实体模型

### ChatRecord（聊天记录）
聊天记录实体存储用户与AI交互的详细信息。

**字段定义：**
- id: 主键，自增BigInteger
- chat_id: 所属会话ID，非空BigInteger
- ai_modal_id: 使用的AI模型ID，可为空
- first_chat: 是否为首次对话，布尔值，默认False
- create_time: 创建时间，DateTime
- finish_time: 完成时间，DateTime
- create_by: 创建者ID，BigInteger
- datasource: 数据源ID，可为空
- engine_type: 数据库引擎类型，最大长度64
- question: 用户提问，Text类型
- sql_answer: SQL执行结果，Text类型
- sql: 生成的SQL语句，Text类型
- sql_exec_result: SQL执行结果，Text类型
- data: 数据结果，Text类型
- chart_answer: 图表结果，Text类型
- chart: 图表配置，Text类型
- analysis: 分析结果，Text类型
- predict: 预测结果，Text类型
- predict_data: 预测数据，Text类型
- recommended_question_answer: 推荐问题答案，Text类型
- recommended_question: 推荐问题，Text类型
- datasource_select_answer: 数据源选择答案，Text类型
- finish: 是否完成，布尔值，默认False
- error: 错误信息，Text类型
- analysis_record_id: 分析记录ID，可为空
- predict_record_id: 预测记录ID，可为空

**Section sources**
- [chat_model.py](file://backend/apps/chat/models/chat_model.py#L55-L100)

### CoreDatasource（数据源）
数据源实体存储数据库连接配置信息。

**字段定义：**
- id: 主键，自增Integer
- name: 数据源名称，最大长度128，非空
- description: 描述，最大长度512，可为空
- type: 数据源类型，最大长度64
- type_name: 类型名称，最大长度64，可为空
- configuration: 连接配置，Text类型，存储加密的连接信息
- create_time: 创建时间，DateTime
- create_by: 创建者ID，BigInteger
- status: 状态，最大长度64，可为空
- num: 编号，最大长度256，可为空
- oid: 组织ID，BigInteger

**Section sources**
- [datasource.py](file://backend/apps/datasource/models/datasource.py#L4-L20)
- [003_add_datasource.py](file://backend/alembic/versions/003_add_datasource.py#L20-L30)

### CoreDashboard（仪表板）
仪表板实体存储可视化看板的配置信息。

**字段定义：**
- id: 主键，长度50的字符串
- name: 名称，最大长度255，可为空
- pid: 父ID，长度50的字符串，可为空
- workspace_id: 工作空间ID，长度50的字符串，可为空
- org_id: 组织ID，长度50的字符串，可为空
- level: 层级，Integer，可为空
- node_type: 节点类型，最大长度255，可为空
- type: 类型，最大长度50，可为空
- canvas_style_data: 画布样式数据，Text类型，可为空
- component_data: 组件数据，Text类型，可为空
- canvas_view_info: 画布视图信息，Text类型，可为空
- mobile_layout: 移动端布局，SmallInteger，默认0
- status: 状态，Integer，默认1
- self_watermark_status: 自定义水印状态，Integer，默认0
- sort: 排序，Integer，默认0
- create_time: 创建时间，BigInteger，可为空
- create_by: 创建者，最大长度255，可为空
- update_time: 更新时间，BigInteger，可为空
- update_by: 更新者，最大长度255，可为空
- remark: 备注，最大长度255，可为空
- source: 来源，最大长度255，可为空
- delete_flag: 删除标志，SmallInteger，默认0
- delete_time: 删除时间，BigInteger，可为空
- delete_by: 删除者，最大长度255，可为空
- version: 版本，Integer，默认3
- content_id: 内容ID，最大长度50，默认'0'
- check_version: 检查版本，最大长度50，默认'1'

**Section sources**
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py#L8-L80)
- [009_1_add_core_dashboard.py](file://backend/alembic/versions/009_1_add_core_dashboard.py#L20-L35)

### AiModelDetail（AI模型配置）
AI模型配置实体存储AI服务的连接和配置信息。

**字段定义：**
- id: 主键，BigInteger
- api_key: API密钥，最大长度255，可为空
- api_domain: API域名，最大长度255，非空
- protocol: 协议类型，Integer，非空，默认1
- supplier: 供应商，Integer，非空
- name: 模型名称，最大长度255，非空
- model_type: 模型类型，Integer，非空
- base_model: 基础模型，最大长度255，非空
- default_model: 是否为默认模型，布尔值，非空，默认False
- config: 配置信息，Text类型，非空
- status: 状态，Integer，非空，默认1
- create_time: 创建时间，BigInteger，默认0

**Section sources**
- [system_model.py](file://backend/apps/system/models/system_model.py#L20-L30)
- [019_upgrade_model.py](file://backend/alembic/versions/019_upgrade_model.py#L20-L35)

## 实体关系图

```mermaid
erDiagram
USER {
uuid id PK
string name
string email
timestamp create_time
}
WORKSPACE {
uuid id PK
string name
timestamp create_time
}
USER_WORKSPACE {
uuid uid FK
uuid oid FK
int weight
PRIMARY KEY (uid, oid)
}
CORE_DATASOURCE {
int id PK
string name
string description
string type
string configuration
datetime create_time
bigint create_by FK
string status
string num
bigint oid FK
}
CHAT {
bigint id PK
datetime create_time
bigint create_by FK
string brief
string chat_type
bigint datasource FK
string engine_type
int origin
bigint oid FK
}
CHAT_RECORD {
bigint id PK
bigint chat_id FK
bigint ai_modal_id FK
bool first_chat
datetime create_time
datetime finish_time
bigint create_by FK
bigint datasource FK
string engine_type
text question
text sql_answer
text sql
text sql_exec_result
text data
text chart_answer
text chart
text analysis
text predict
text predict_data
text recommended_question
text datasource_select_answer
bool finish
text error
bigint analysis_record_id FK
bigint predict_record_id FK
}
CORE_DASHBOARD {
string id PK
string name
string pid
string workspace_id FK
string org_id FK
int level
string node_type
string type
text canvas_style_data
text component_data
text canvas_view_info
smallint mobile_layout
int status
int self_watermark_status
int sort
bigint create_time
string create_by FK
bigint update_time
string update_by FK
string remark
string source
smallint delete_flag
bigint delete_time
string delete_by FK
int version
string content_id
string check_version
}
AI_MODEL {
bigint id PK
string api_key
string api_domain
int protocol
int supplier
string name
int model_type
string base_model
bool default_model
text config
int status
bigint create_time
}
USER ||--o{ CHAT : creates
USER ||--o{ CHAT_RECORD : creates
USER ||--o{ CORE_DASHBOARD : creates
USER ||--o{ CORE_DATASOURCE : creates
USER ||--o{ AI_MODEL : creates
USER ||--o{ USER_WORKSPACE : belongs_to
WORKSPACE ||--o{ USER_WORKSPACE : contains
WORKSPACE ||--o{ CHAT : contains
WORKSPACE ||--o{ CORE_DASHBOARD : contains
WORKSPACE ||--o{ CORE_DATASOURCE : contains
CHAT ||--o{ CHAT_RECORD : contains
CORE_DATASOURCE ||--o{ CHAT : uses
AI_MODEL ||--o{ CHAT_RECORD : uses
CORE_DASHBOARD ||--o{ CHAT : embedded_in
```

**Diagram sources**
- [chat_model.py](file://backend/apps/chat/models/chat_model.py)
- [datasource.py](file://backend/apps/datasource/models/datasource.py)
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py)
- [system_model.py](file://backend/apps/system/models/system_model.py)
- [020_workspace_ddl.py](file://backend/alembic/versions/020_workspace_ddl.py)
- [021_user_ws_ddl.py](file://backend/alembic/versions/021_user_ws_ddl.py)

## 数据库迁移策略

### 版本控制
系统使用Alembic进行数据库版本控制，所有迁移脚本存储在`backend/alembic/versions/`目录下，按版本号顺序执行。每个迁移脚本包含唯一的`Revision ID`和`down_revision`指针，形成迁移链。

### 升级流程
1. 开发人员修改SQLModel定义
2. 运行`alembic revision --autogenerate`生成迁移脚本
3. 检查并调整自动生成的脚本
4. 运行`alembic upgrade head`应用所有待执行的迁移

### 降级流程
1. 运行`alembic downgrade <target_revision>`回滚到指定版本
2. 系统按迁移链逆序执行`downgrade()`函数
3. 每个`downgrade()`函数撤销对应`upgrade()`函数的操作

### 最佳实践
- 所有数据库变更必须通过迁移脚本执行
- 生产环境迁移前需在测试环境验证
- 重要数据变更需备份
- 迁移脚本应包含完整的`upgrade()`和`downgrade()`函数
- 避免在迁移中执行大量数据处理

**Section sources**
- [003_add_datasource.py](file://backend/alembic/versions/003_add_datasource.py)
- [004_add_aimodel_auto.py](file://backend/alembic/versions/004_add_aimodel_auto.py)
- [007_add_chat.py](file://backend/alembic/versions/007_add_chat.py)
- [009_1_add_core_dashboard.py](file://backend/alembic/versions/009_1_add_core_dashboard.py)
- [019_upgrade_model.py](file://backend/alembic/versions/019_upgrade_model.py)

## 关键表设计考量

### 聊天记录表的分表策略
聊天记录表(CHAT_RECORD)设计考虑了性能和可扩展性：
- 使用`chat_id`作为逻辑分区键，便于按会话查询
- 所有大文本字段使用Text类型，避免长度限制
- `create_time`和`finish_time`使用DateTime类型，便于时间范围查询
- `finish`字段作为完成标志，便于状态管理
- `analysis_record_id`和`predict_record_id`支持复杂分析场景的关联查询

### 数据源配置的加密存储方案
数据源配置(CORE_DATASOURCE.configuration)采用加密存储方案：
- 敏感信息（如密码）在存储前进行加密
- 配置信息以JSON格式存储，便于扩展
- `type`字段标识数据源类型，支持多种数据库
- `status`字段管理数据源的可用状态
- `oid`字段实现多租户隔离，不同组织的数据源相互隔离

**Section sources**
- [chat_model.py](file://backend/apps/chat/models/chat_model.py#L55-L100)
- [datasource.py](file://backend/apps/datasource/models/datasource.py#L4-L20)

## 结论
SQLBot系统的数据库设计充分考虑了功能需求、性能要求和可维护性。通过合理的实体设计和关系建模，系统能够有效支持聊天交互、数据可视化、AI模型管理和多租户协作等核心功能。Alembic迁移框架确保了数据库结构的版本控制和安全演进，而关键表的设计考量则保证了系统的高性能和可扩展性。
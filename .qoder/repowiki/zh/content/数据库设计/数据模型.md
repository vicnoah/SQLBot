# 数据模型

<cite>
**本文档中引用的文件**  
- [chat_model.py](file://backend/apps/chat/models/chat_model.py)
- [datasource.py](file://backend/apps/datasource/models/datasource.py)
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py)
- [system_model.py](file://backend/apps/system/models/system_model.py)
- [user.py](file://backend/apps/system/models/user.py)
- [models.py](file://backend/common/core/models.py)
</cite>

## 目录
1. [引言](#引言)
2. [核心数据模型](#核心数据模型)
   - [ChatRecord（聊天记录）](#chatrecord聊天记录)
   - [CoreDatasource（数据源）](#coredatasource数据源)
   - [CoreDashboard（仪表板）](#coredashboard仪表板)
   - [AiModelDetail（AI模型配置）](#aimodeldetailai模型配置)
   - [UserInfoDTO（用户信息）](#userinfodto用户信息)
   - [Workspace（工作空间）](#workspace工作空间)
3. [基类与通用机制](#基类与通用机制)
   - [SnowflakeBase ID生成机制](#snowflakebase-id生成机制)
   - [JSON编码规则](#json编码规则)
4. [模型映射与数据访问](#模型映射与数据访问)
   - [SQLModel与数据库表映射](#sqlmodel与数据库表映射)
   - [典型数据访问模式](#典型数据访问模式)
   - [查询示例](#查询示例)

## 引言
本文档全面描述了系统中的核心数据模型，涵盖聊天记录、数据源、仪表板、AI模型配置、用户信息及工作空间等关键实体。详细说明各字段的定义、数据类型、约束条件和默认值，并解释其业务含义与使用场景。特别阐述了基于Snowflake算法的ID生成机制和JSON编码规则，确保前后端数据交互的一致性。

## 核心数据模型

### ChatRecord（聊天记录）
表示一次会话中的具体交互记录，存储用户提问、系统响应及执行结果。

**字段说明：**
- `id`: 主键，自增大整数，唯一标识每条记录。
- `chat_id`: 所属会话ID，非空，关联`chat`表。
- `ai_modal_id`: 使用的AI模型ID，可为空。
- `first_chat`: 是否为首次交互，布尔值，默认`false`。
- `create_time`: 创建时间，日期时间类型，可为空。
- `finish_time`: 完成时间，日期时间类型，可为空。
- `create_by`: 创建者用户ID，大整数。
- `datasource`: 使用的数据源ID，可为空。
- `engine_type`: 数据库引擎类型，字符串（最大64字符），可为空。
- `question`: 用户原始问题，文本类型，可为空。
- `sql_answer`: SQL生成结果，文本类型，可为空。
- `sql`: 执行的SQL语句，文本类型，可为空。
- `sql_exec_result`: SQL执行结果集，文本类型，可为空。
- `data`: 数据结果（通用），文本类型，可为空。
- `chart_answer`: 图表生成结果，文本类型，可为空。
- `chart`: 图表配置，文本类型，可为空。
- `analysis`: 数据分析结果，文本类型，可为空。
- `predict`: 预测分析结果，文本类型，可为空。
- `predict_data`: 预测数据，文本类型，可为空。
- `recommended_question_answer`: 推荐问题生成结果，文本类型，可为空。
- `recommended_question`: 推荐问题列表，文本类型，可为空。
- `datasource_select_answer`: 数据源选择结果，文本类型，可为空。
- `finish`: 交互是否完成，布尔值，默认`false`。
- `error`: 错误信息，文本类型，可为空。
- `analysis_record_id`: 关联的分析记录ID，大整数，可为空。
- `predict_record_id`: 关联的预测记录ID，大整数，可为空。

**业务含义：** 该模型是系统的核心，记录了从用户提问到AI生成SQL、执行、可视化、分析、预测等完整流程的每一个环节，支持会话追溯和审计。

**Section sources**
- [chat_model.py](file://backend/apps/chat/models/chat_model.py#L76-L103)

### CoreDatasource（数据源）
表示系统中配置的数据源连接信息。

**字段说明：**
- `id`: 主键，自增整数，唯一标识每个数据源。
- `name`: 数据源名称，字符串（最大128字符），非空。
- `description`: 描述信息，字符串（最大512字符），可为空。
- `type`: 数据源类型（如mysql, postgres等），字符串（最大64字符）。
- `type_name`: 类型名称，字符串（最大64字符），可为空。
- `configuration`: 连接配置（JSON格式存储），文本类型，非空。
- `create_time`: 创建时间，日期时间类型，可为空。
- `create_by`: 创建者用户ID，大整数。
- `status`: 状态（如active, inactive），字符串（最大64字符），可为空。
- `num`: 编号，字符串（最大256字符），可为空。
- `oid`: 组织ID，大整数。

**加密字段处理：** `configuration`字段中包含密码等敏感信息，在存储前会进行加密处理，确保数据安全。

**业务含义：** 该模型用于管理所有外部数据库的连接，是执行SQL查询和生成分析的基础。

**Section sources**
- [datasource.py](file://backend/apps/datasource/models/datasource.py#L8-L20)

### CoreDashboard（仪表板）
表示一个仪表板实例，包含其布局、组件和样式信息。

**字段说明：**
- `id`: 主键，字符串（最大50字符），非空。
- `name`: 仪表板名称，字符串（最大255字符），可为空。
- `pid`: 父级ID，用于构建树形结构，字符串（最大50字符），可为空。
- `workspace_id`: 所属工作空间ID，字符串（最大50字符），可为空。
- `org_id`: 组织ID，字符串（最大50字符），可为空。
- `level`: 层级，整数，可为空。
- `node_type`: 节点类型，字符串（最大255字符），可为空。
- `type`: 仪表板类型，字符串（最大50字符），可为空。
- `canvas_style_data`: 画布样式数据（JSON），文本类型，可为空。
- `component_data`: 组件数据（JSON），文本类型，可为空。
- `canvas_view_info`: 画布视图信息（JSON），文本类型，可为空。
- `mobile_layout`: 移动端布局，小整数，默认`0`。
- `status`: 状态，整数，默认`1`。
- `self_watermark_status`: 自定义水印状态，整数，默认`0`。
- `sort`: 排序值，整数，默认`0`。
- `create_time`: 创建时间，大整数时间戳。
- `create_by`: 创建者，字符串（最大255字符），可为空。
- `update_time`: 更新时间，大整数时间戳，可为空。
- `update_by`: 更新者，字符串（最大255字符），可为空。
- `remark`: 备注，字符串（最大255字符），可为空。
- `source`: 来源，字符串（最大255字符），可为空。
- `delete_flag`: 删除标记，小整数，默认`0`。
- `delete_time`: 删除时间，大整数时间戳，可为空。
- `delete_by`: 删除者，字符串（最大255字符），可为空。
- `version`: 版本号，整数，默认`3`。
- `content_id`: 内容ID，字符串（最大50字符），默认`'0'`。
- `check_version`: 检查版本，字符串（最大50字符），默认`'1'`。

**业务含义：** 该模型存储了仪表板的所有元数据，支持复杂的可视化布局和状态管理。

**Section sources**
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py#L5-L126)

### AiModelDetail（AI模型配置）
表示AI模型的详细配置信息。

**字段说明：**
- `id`: 主键，由SnowflakeBase提供，大整数。
- `supplier`: 供应商ID，非空。
- `name`: 模型名称，字符串（最大255字符），非空。
- `model_type`: 模型类型，非空。
- `base_model`: 基础模型名称，字符串（最大255字符），非空。
- `default_model`: 是否为默认模型，布尔值，默认`false`。
- `api_key`: API密钥，字符串（最大255字符），可为空（敏感信息需加密）。
- `api_domain`: API域名，字符串（最大255字符），非空。
- `protocol`: 协议类型，整数，默认`1`。
- `config`: 配置信息（JSON），文本类型。
- `status`: 状态，整数，默认`1`。
- `create_time`: 创建时间，大整数时间戳，默认`0`。

**业务含义：** 该模型用于管理所有可用的AI模型及其访问凭证，是系统调用大模型服务的基础。

**Section sources**
- [system_model.py](file://backend/apps/system/models/system_model.py#L14-L21)

### UserInfoDTO（用户信息）
表示系统用户的基本信息。

**字段说明：**
- `id`: 主键，由SnowflakeBase提供，大整数。
- `account`: 账号，字符串（最大255字符），唯一。
- `oid`: 组织ID，大整数，非空，默认`0`。
- `name`: 用户名，字符串（最大255字符），唯一。
- `password`: 密码，字符串（最大255字符），默认为MD5加密的默认值。
- `email`: 邮箱，字符串（最大255字符）。
- `status`: 状态，整数，默认`0`。
- `create_time`: 创建时间，大整数时间戳，非空。
- `language`: 语言偏好，字符串（最大255字符），默认`"zh-CN"`。

**业务含义：** 该模型存储了系统用户的认证和基本信息，支持多租户和权限管理。

**Section sources**
- [user.py](file://backend/apps/system/models/user.py#L20-L21)

### Workspace（工作空间）
表示一个工作空间，用于组织和隔离资源。

**字段说明：**
- `id`: 主键，由SnowflakeBase提供，大整数。
- `name`: 工作空间名称，字符串（最大255字符），非空。
- `create_time`: 创建时间，大整数时间戳，默认`0`。

**业务含义：** 该模型实现了多租户架构中的资源隔离，不同工作空间的用户和数据相互独立。

**Section sources**
- [system_model.py](file://backend/apps/system/models/system_model.py#L32-L34)

## 基类与通用机制

### SnowflakeBase ID生成机制
`SnowflakeBase`是所有核心模型的基类，提供全局唯一ID生成能力。

**实现细节：**
- 使用Twitter的Snowflake算法生成64位唯一ID。
- ID由时间戳、机器ID、序列号等部分组成，保证分布式环境下的唯一性。
- 在`common.utils.snowflake`模块中实现`generate_id`函数。
- 所有继承`SnowflakeBase`的模型（如`UserModel`, `AiModelDetail`, `WorkspaceModel`）的`id`字段均通过`default_factory=snowflake.generate_id`自动填充。

**优势：** 避免了数据库自增ID在分布式部署时的冲突问题，同时保持了ID的有序性和可读性。

**Section sources**
- [models.py](file://backend/common/core/models.py#L6-L18)

### JSON编码规则
为解决JavaScript中大整数精度丢失问题，系统定义了统一的JSON编码规则。

**实现细节：**
- 在`SnowflakeBase`的`Config`类中定义`json_encoders`。
- 规则：当一个整数（int）大于`2^53 - 1`时，将其序列化为字符串（str）；否则保持原样。
- 这确保了由Snowflake生成的大ID在通过API传输到前端时不会丢失精度。

**示例：** 一个值为`9007199254740993`的ID，在JSON响应中会被编码为字符串`"9007199254740993"`，前端可安全解析。

**Section sources**
- [models.py](file://backend/common/core/models.py#L6-L18)

## 模型映射与数据访问

### SQLModel与数据库表映射
系统使用SQLModel库实现ORM，模型类与数据库表通过`__tablename__`属性直接映射。

**映射关系：**
- `ChatRecord` -> `chat_record` 表
- `CoreDatasource` -> `core_datasource` 表
- `CoreDashboard` -> `core_dashboard` 表
- `AiModelDetail` -> `ai_model` 表
- `UserModel` -> `sys_user` 表
- `WorkspaceModel` -> `sys_workspace` 表

**Section sources**
- [chat_model.py](file://backend/apps/chat/models/chat_model.py#L76-L103)
- [datasource.py](file://backend/apps/datasource/models/datasource.py#L8-L20)
- [dashboard_model.py](file://backend/apps/dashboard/models/dashboard_model.py#L5-L126)
- [system_model.py](file://backend/apps/system/models/system_model.py#L14-L21)
- [user.py](file://backend/apps/system/models/user.py#L20-L21)

### 典型数据访问模式
1. **会话管理：** 通过`chat_id`查询`ChatRecord`获取完整会话历史。
2. **数据源操作：** 根据`create_by`和`oid`筛选用户可访问的数据源。
3. **仪表板加载：** 查询`CoreDashboard`并解析`component_data`和`canvas_style_data`以渲染UI。
4. **AI模型调用：** 根据`status`筛选可用模型，并获取`api_key`和`api_domain`进行调用。
5. **用户权限验证：** 结合`UserModel`和`UserWsModel`确定用户在特定工作空间的权限。

### 查询示例
```sql
-- 查询特定会话的所有记录
SELECT * FROM chat_record WHERE chat_id = 123 ORDER BY create_time;

-- 查询用户创建的所有活跃数据源
SELECT id, name, type FROM core_datasource 
WHERE create_by = 456 AND status = 'active';

-- 查询工作空间下的所有仪表板
SELECT id, name, pid, level FROM core_dashboard 
WHERE workspace_id = 'ws-789' AND delete_flag = 0;
```
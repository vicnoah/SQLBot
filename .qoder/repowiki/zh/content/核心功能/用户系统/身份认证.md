# 身份认证

<cite>
**本文档中引用的文件**  
- [login.py](file://backend/apps/system/api/login.py)
- [auth.py](file://backend/apps/system/middleware/auth.py)
- [security.py](file://backend/common/core/security.py)
- [user.py](file://backend/apps/system/crud/user.py)
- [whitelist.py](file://backend/common/utils/whitelist.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心认证流程](#核心认证流程)
3. [登录接口实现](#登录接口实现)
4. [JWT令牌机制](#jwt令牌机制)
5. [密码安全机制](#密码安全机制)
6. [白名单机制](#白名单机制)
7. [认证中间件](#认证中间件)
8. [API调用示例](#api调用示例)
9. [错误处理](#错误处理)
10. [前端交互流程](#前端交互流程)

## 简介
本系统实现了基于JWT（JSON Web Token）的身份认证机制，为用户提供安全可靠的登录和访问控制功能。认证系统主要由登录接口、JWT令牌管理、密码安全存储、白名单免认证访问和中间件拦截验证等组件构成。系统采用MD5加密算法存储用户密码，并通过OAuth2PasswordRequestForm处理登录凭证。认证中间件负责拦截请求并验证令牌有效性，同时为特定路径提供免认证访问的白名单机制。

## 核心认证流程
```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant 登录接口 as /login/access-token
participant 认证服务 as authenticate()
participant 令牌服务 as create_access_token()
participant 中间件 as TokenMiddleware
participant 后端服务 as 后端API服务
前端->>登录接口 : 提交账号密码
登录接口->>认证服务 : 验证凭证
认证服务-->>登录接口 : 返回用户信息或失败
登录接口->>令牌服务 : 生成JWT令牌
令牌服务-->>登录接口 : 返回JWT令牌
登录接口-->>前端 : 返回令牌
前端->>后端服务 : 请求(含Authorization头)
后端服务->>中间件 : 拦截请求
中间件->>中间件 : 检查白名单
中间件->>中间件 : 验证JWT令牌
中间件-->>后端服务 : 设置current_user
后端服务-->>前端 : 返回响应
```

**Diagram sources**  
- [login.py](file://backend/apps/system/api/login.py#L15-L34)
- [auth.py](file://backend/apps/system/middleware/auth.py#L20-L198)
- [security.py](file://backend/common/core/security.py#L14-L20)

**Section sources**
- [login.py](file://backend/apps/system/api/login.py#L1-L34)
- [auth.py](file://backend/apps/system/middleware/auth.py#L1-L198)

## 登录接口实现
系统通过`/login/access-token`接口处理用户登录请求，该接口使用FastAPI的OAuth2PasswordRequestForm来接收和处理凭证。登录流程包括账号密码验证、用户状态检查和工作空间关联验证。成功认证后，系统生成JWT访问令牌并返回给客户端。

```mermaid
flowchart TD
A[接收登录请求] --> B[提取账号密码]
B --> C[调用authenticate验证]
C --> D{验证成功?}
D --> |否| E[返回400错误]
D --> |是| F{用户已启用?}
F --> |否| G[返回用户禁用错误]
F --> |是| H{已关联工作空间?}
H --> |否| I[返回未关联错误]
H --> |是| J[生成访问令牌]
J --> K[返回令牌响应]
```

**Diagram sources**  
- [login.py](file://backend/apps/system/api/login.py#L15-L34)
- [user.py](file://backend/apps/system/crud/user.py#L38-L44)

**Section sources**
- [login.py](file://backend/apps/system/api/login.py#L15-L34)

## JWT令牌机制
系统采用JWT标准实现无状态认证，令牌包含用户信息和过期时间。令牌的生成、验证和刷新流程确保了系统的安全性和可扩展性。

### 令牌生成
```mermaid
flowchart TD
A[调用create_access_token] --> B[复制用户数据]
B --> C[计算过期时间]
C --> D[添加exp声明]
D --> E[使用SECRET_KEY签名]
E --> F[返回JWT令牌]
```

### 令牌验证
```mermaid
flowchart TD
A[提取Authorization头] --> B{头存在?}
B --> |否| C[返回未授权]
B --> |是| D[解析Bearer模式]
D --> E{模式正确?}
E --> |否| F[返回格式错误]
E --> |是| G[解码JWT令牌]
G --> H{签名有效?}
H --> |否| I[返回签名无效]
H --> |是| I[检查是否过期]
I --> J{已过期?}
J --> |是| K[返回令牌过期]
J --> |否| L[查询用户信息]
L --> M{用户存在?}
M --> |否| N[返回用户不存在]
M --> |是| O[检查用户状态]
O --> P{已启用?}
P --> |否| Q[返回用户禁用]
P --> |是| R[设置current_user]
R --> S[继续请求处理]
```

**Diagram sources**  
- [security.py](file://backend/common/core/security.py#L14-L20)
- [auth.py](file://backend/apps/system/middleware/auth.py#L100-L130)

**Section sources**
- [security.py](file://backend/common/core/security.py#L14-L20)
- [auth.py](file://backend/apps/system/middleware/auth.py#L100-L130)

## 密码安全机制
系统采用MD5哈希算法存储用户密码，确保密码数据的安全性。通过专门的验证函数检查用户输入的密码与存储的哈希值是否匹配。

```mermaid
classDiagram
class security{
+md5pwd(password : str) str
+verify_md5pwd(plain_password : str, md5_password : str) bool
+default_pwd() str
+default_md5_pwd() str
}
class user{
+authenticate(session : Session, account : str, password : str) BaseUserDTO | None
+get_user_by_account(session : Session, account : str) BaseUserDTO | None
+verify_md5pwd(plain_password : str, md5_password : str) bool
}
security --> user : "被调用"
user --> security : "密码验证"
```

**Diagram sources**  
- [security.py](file://backend/common/core/security.py#L35-L36)
- [user.py](file://backend/apps/system/crud/user.py#L38-L44)

**Section sources**
- [security.py](file://backend/common/core/security.py#L35-L36)
- [user.py](file://backend/apps/system/crud/user.py#L38-L44)

## 白名单机制
系统实现了灵活的白名单机制，允许特定路径无需认证即可访问。白名单配置支持通配符和正则表达式匹配，为静态资源和公共API提供便利。

```mermaid
flowchart TD
A[请求到达] --> B[检查是否为OPTIONS]
B --> |是| C[直接放行]
B --> |否| D[检查白名单]
D --> E{路径在白名单?}
E --> |是| F[设置默认管理员]
E --> |否| G[执行令牌验证]
F --> H[继续请求处理]
G --> I[验证令牌]
I --> J[继续请求处理]
```

**Diagram sources**  
- [whitelist.py](file://backend/common/utils/whitelist.py#L1-L82)
- [auth.py](file://backend/apps/system/middleware/auth.py#L35-L45)

**Section sources**
- [whitelist.py](file://backend/common/utils/whitelist.py#L1-L82)
- [auth.py](file://backend/apps/system/middleware/auth.py#L35-L45)

## 认证中间件
TokenMiddleware是系统的核心认证组件，负责拦截所有请求并执行认证逻辑。中间件首先检查请求路径是否在白名单中，然后根据请求头中的令牌类型执行相应的验证流程。

```mermaid
classDiagram
class TokenMiddleware{
+__init__(app)
+dispatch(request, call_next)
+is_options(request) bool
+set_default_admin_user(request)
+validateToken(token, trans) tuple[bool, any]
+validateAssistant(assistantToken, trans) tuple[any]
+validateEmbedded(param, trans) tuple[any]
}
class WhitelistChecker{
+whitelist : List[str]
+_compiled_patterns : List[Pattern]
+__init__(paths : List[str])
+is_whitelisted(path : str) bool
+add_path(path : str)
+_compile_patterns()
}
TokenMiddleware --> WhitelistChecker : "使用"
TokenMiddleware --> security : "使用"
TokenMiddleware --> user : "查询用户"
```

**Diagram sources**  
- [auth.py](file://backend/apps/system/middleware/auth.py#L20-L198)
- [whitelist.py](file://backend/common/utils/whitelist.py#L10-L75)

**Section sources**
- [auth.py](file://backend/apps/system/middleware/auth.py#L20-L198)

## API调用示例
以下是使用curl命令进行认证的API调用示例：

```bash
# 登录获取令牌
curl -X POST "http://localhost:8000/api/v1/login/access-token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin" \
  -d "password=admin"

# 使用令牌访问受保护的API
curl -X GET "http://localhost:8000/api/v1/system/user" \
  -H "Authorization: Bearer <your-jwt-token>"
```

## 错误处理
系统实现了全面的错误处理机制，针对不同的认证失败场景返回相应的错误信息：

```mermaid
flowchart TD
A[认证失败] --> B{失败原因}
B --> C[账号密码错误]
B --> D[用户已禁用]
B --> E[未关联工作空间]
B --> F[令牌缺失]
B --> G[令牌格式错误]
B --> H[令牌过期]
B --> I[签名无效]
C --> J[返回400: 账号密码错误]
D --> K[返回400: 用户已禁用]
E --> L[返回400: 未关联工作空间]
F --> M[返回401: 缺少令牌]
G --> N[返回401: 令牌格式错误]
H --> O[返回401: 令牌过期]
I --> P[返回401: 签名无效]
```

**Section sources**
- [login.py](file://backend/apps/system/api/login.py#L20-L34)
- [auth.py](file://backend/apps/system/middleware/auth.py#L100-L130)

## 前端交互流程
前端登录界面与后端API的完整交互流程如下：

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 前端 as 前端界面
participant 后端 as 后端API
participant 数据库 as 数据库
用户->>前端 : 输入账号密码
前端->>后端 : POST /login/access-token
后端->>数据库 : 查询用户信息
数据库-->>后端 : 返回用户数据
后端->>后端 : 验证密码(MD5)
后端->>后端 : 检查用户状态
后端->>后端 : 检查工作空间
后端->>后端 : 生成JWT令牌
后端-->>前端 : 返回令牌
前端->>前端 : 存储令牌(Cookie/LocalStorage)
前端->>后端 : 后续请求(Authorization头)
后端->>后端 : 验证令牌
后端-->>前端 : 返回响应
前端->>用户 : 显示内容
```

**Diagram sources**  
- [login.py](file://backend/apps/system/api/login.py#L15-L34)
- [auth.py](file://backend/apps/system/middleware/auth.py#L20-L198)

**Section sources**
- [login.py](file://backend/apps/system/api/login.py#L15-L34)
- [auth.py](file://backend/apps/system/middleware/auth.py#L20-L198)